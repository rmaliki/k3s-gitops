apiVersion: v1
kind: Namespace
metadata:
  name: ledger-core
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ledger-core
  namespace: ledger-core
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ledger-core
  namespace: ledger-core
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ledger-core
  template:
    metadata:
      labels:
        app: ledger-core
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/agent-pre-populate-only: "true"
        vault.hashicorp.com/role: "ledger-core"
        vault.hashicorp.com/agent-inject-secret-ledger-env: "kv/data/ledger/core"
        vault.hashicorp.com/agent-inject-template-ledger-env: |
          {{- with secret "kv/data/ledger/core" -}}
          export QONTO_API_KEY="{{ .Data.data.QONTO_API_KEY }}"
          export QONTO_ORGANIZATION_ID="{{ .Data.data.QONTO_ORGANIZATION_ID }}"
          {{- end }}
    spec:
      serviceAccountName: ledger-core
      containers:
      - name: backend
        image: qonto/qonto-mcp-server:latest
        command: ["/bin/sh", "-ec"]
        args:
        - |
          . /vault/secrets/ledger-env
          python qonto_mcp/server.py --transport streamable-http
        env:
        - name: QONTO_THIRDPARTY_HOST
          value: "https://thirdparty.qonto.com"
      - name: http-proxy
        image: alpine/socat:1.8.0.1
        args:
        - "TCP-LISTEN:8080,fork,reuseaddr"
        - "TCP:127.0.0.1:8000"
        ports:
        - name: http
          containerPort: 8080
        readinessProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 3
          periodSeconds: 10
        livenessProbe:
          tcpSocket:
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 20
---
apiVersion: v1
kind: Service
metadata:
  name: ledger-core
  namespace: ledger-core
spec:
  type: ClusterIP
  selector:
    app: ledger-core
  ports:
  - name: http
    port: 8000
    targetPort: 8080
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: ledger-core-ipwhitelist
  namespace: ledger-core
spec:
  ipAllowList:
    sourceRange:
    - 91.134.255.219/32
    - 88.163.194.103/32
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ledger-core
  namespace: ledger-core
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.middlewares: ledger-core-ledger-core-ipwhitelist@kubernetescrd
spec:
  tls:
  - hosts:
    - ledger.tools.datakushi.com
    secretName: ledger-core-tls
  rules:
  - host: ledger.tools.datakushi.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: ledger-core
            port:
              number: 8000
